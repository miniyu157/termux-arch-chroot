#!/data/data/com.termux/files/usr/bin/sh

# 如果不是 root, 使用 su -c 重新执行脚本自身
if [ "$(id -u)" -ne 0 ]; then
    # shellcheck disable=SC2016
    exec su -mm -c 'exec "$0" "$@"' "$0" "$@"
fi

# Chroot 路径
ChrootPath="/data/local/tmp/arch"

# 颜色定义
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
RESET='\033[0m'

# 详细模式标志
Verbose=0
if [ "$1" = "-v" ]; then
    Verbose=1
fi

# 输出函数 (仅在 Verbose=1 时输出)
print_info() { [ $Verbose -eq 1 ] && printf "${CYAN}[i]${RESET} %s\n" "$1"; }
print_success() { [ $Verbose -eq 1 ] && printf "${GREEN}[+]${RESET} %s\n" "$1"; }
print_warning() { [ $Verbose -eq 1 ] && printf "${YELLOW}[!]${RESET} %s\n" "$1"; }
print_error() { [ $Verbose -eq 1 ] && printf "${RED}[-]${RESET} %s\n" "$1"; }

# 解决用户切换的 suid 问题
mount -o remount,dev,suid /data 2> /dev/null

# 创建 Chroot 内部所需文件夹
mkdir -p $ChrootPath/dev/pts
mkdir -p $ChrootPath/dev/shm
mkdir -p $ChrootPath/proc
mkdir -p $ChrootPath/sys
mkdir -p $ChrootPath/sys/fs/cgroup
mkdir -p $ChrootPath/sdcard

# 统一挂载函数
# $1: 挂载点 (chroot 内的相对路径)
# $2: 挂载命令 (如 "mount --bind /dev")
# $3: 成功时的附加信息 (如 "(tmpfs 512M)")
mount_if_needed() {
    target_path="$ChrootPath/$1"
    mount_cmd="$2"
    info="$3"

    if ! mountpoint -q "$target_path"; then
        if $mount_cmd "$target_path" 2> /dev/null; then
            print_success "挂载: $target_path $info"
        else
            print_error "失败: $target_path"
        fi
    else
        print_warning "跳过: $target_path (已挂载)"
    fi
}

# --- 执行挂载 ---
mount_if_needed "dev" "mount --bind /dev"
mount_if_needed "dev/pts" "mount -t devpts devpts"
mount_if_needed "dev/shm" "mount -t tmpfs -o size=512M tmpfs" "(tmpfs 512M)"
mount_if_needed "proc" "mount --bind /proc"
mount_if_needed "sys" "mount --bind /sys"
mount_if_needed "sys/fs/cgroup" "mount -t cgroup2 cgroup2" "(cgroup2)"
mount_if_needed "sdcard" "mount --bind /sdcard"

# 挂载 tmp
mkdir -p /data/data/com.termux/files/usr/tmp
chmod 1777 /data/data/com.termux/files/usr/tmp
mkdir -p $ChrootPath/tmp
mount --bind /data/data/com.termux/files/usr/tmp "$ChrootPath/tmp" 2> /dev/null
