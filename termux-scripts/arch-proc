#!/bin/sh

# 如果不是 root，使用 su -c 重新执行脚本自身
if [ "$(id -u)" -ne 0 ]; then
    # shellcheck disable=SC2016
    exec su -c 'exec "$0" "$@"' "$0" "$@"
fi

CHROOT_ROOT="/data/local/tmp/arch"
WAIT_SECS=5

alias ps=/data/data/com.termux/files/usr/bin/ps

usage() {
    cat << EOF
Usage: $0 [pids|ka]
  pids    - 输出匹配 chroot 的 PID（每行一个 PID）
  ka      - 终止所有匹配的 PID（TERM -> wait -> KILL）
  (无参数) - 列表显示 PID UID CMD 三列
EOF
    exit 1
}

collect_pids() {
    find /proc/[0-9]*/root -type l \( -lname "$CHROOT_ROOT" -o -lname "$CHROOT_ROOT/*" \) 2> /dev/null \
        | awk -F'/' '{print $3}'
}

list_table() {
    GRAY="$(printf '\033[90m')"
    RESET="$(printf '\033[0m')"

    ps -p "$(collect_pids | paste -sd, -)" -o uid,pid,ppid,cmd,%cpu,%mem,rss,vsz --no-headers | while IFS= read -r line; do
        ppid=$(printf "%s" "$line" | awk '{print $3}')
        if [ "$ppid" -ne 1 ]; then
            printf "%s%s%s\n" "$GRAY" "$line" "$RESET"
        else
            printf "%s\n" "$line"
        fi
    done
}

kill_all() {
    pids="$(collect_pids)"
    [ -n "$pids" ] || {
        echo "no matching pids"
        return 0
    }

    for pid in $pids; do
        if kill -0 "$pid" 2> /dev/null; then
            kill "$pid" 2> /dev/null || echo "failed to send TERM to $pid"
        fi
    done

    end=$(($(date +%s) + WAIT_SECS))
    while [ "$(date +%s)" -le "$end" ]; do
        alive=0
        for pid in $pids; do
            if kill -0 "$pid" 2> /dev/null; then
                alive=1
                break
            fi
        done
        [ "$alive" -eq 0 ] && break
        sleep 1
    done

    for pid in $pids; do
        if kill -0 "$pid" 2> /dev/null; then
            kill -9 "$pid" 2> /dev/null && echo "SIGKILL $pid" || echo "failed to KILL $pid"
        fi
    done
}

case "$1" in
    "") list_table ;;
    pids) collect_pids ;;
    ka) kill_all ;;
    *) usage ;;
esac
